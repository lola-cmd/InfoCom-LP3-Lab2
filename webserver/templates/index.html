<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Drone in Lund</title>
  <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript">
    function Submit() {
      var from_addr = document.getElementById('faddr').value;
      var to_addr = document.getElementById('taddr').value;
      var data = {
        "faddr": from_addr,
        "taddr": to_addr,
      }
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          try {
            var resp = this.responseText;
            alert(resp);
          }
          catch (err) {
            alert(this.responseText);
          }
        }
      };
      xhttp.open("POST", "http://127.0.0.1:5002/planner", true);
      xhttp.send(JSON.stringify(data));
    }
  </script>
  <script type="text/javascript">
    function LoadPhone(x, y) {
      var phoneLine1 = svg.getElementById("phoneLine1")
      var phoneLine2 = svg.getElementById("phoneLine2")

      if (phoneLine1 == null) {
        phoneLine1 = doc_svg.createElementNS("http://www.w3.org/2000/svg", "line");
        phoneLine1.setAttributeNS(null, 'x1', x - 5);
        phoneLine1.setAttributeNS(null, 'y1', y - 5);
        phoneLine1.setAttributeNS(null, 'x2', x + 5);
        phoneLine1.setAttributeNS(null, 'y2', y + 5);
        phoneLine1.setAttributeNS(null, 'stroke', color);
        phoneLine1.setAttributeNS(null, 'stroke-width', '2');
        phoneLine1.setAttributeNS(null, 'id', "phoneLine1");

        phoneLine2 = doc_svg.createElementNS("http://www.w3.org/2000/svg", "line");
        phoneLine2.setAttributeNS(null, 'x1', x - 5);
        phoneLine2.setAttributeNS(null, 'y1', y + 5);
        phoneLine2.setAttributeNS(null, 'x2', x + 5);
        phoneLine2.setAttributeNS(null, 'y2', y - 5);
        phoneLine2.setAttributeNS(null, 'stroke', color);
        phoneLine2.setAttributeNS(null, 'stroke-width', '2');
        phoneLine2.setAttributeNS(null, 'id', "phoneLine2");

        doc_svg.appendChild(phoneLine1);
        doc_svg.appendChild(phoneLine2);
      }
      else {
        phoneLine1.setAttributeNS(null, 'x1', x - 5);
        phoneLine1.setAttributeNS(null, 'y1', y - 5);
        phoneLine1.setAttributeNS(null, 'x2', x + 5);
        phoneLine1.setAttributeNS(null, 'y2', y + 5);

        phoneLine2.setAttributeNS(null, 'x1', x - 5);
        phoneLine2.setAttributeNS(null, 'y1', y + 5);
        phoneLine2.setAttributeNS(null, 'x2', x + 5);
        phoneLine2.setAttributeNS(null, 'y2', y - 5);
      }
    }
    function LoadDrone(droneID, x, y, status) {
      var doc = document.getElementById("map");
      $(doc).ready(function () {
        var doc_svg = doc.getSVGDocument();
        var svg = doc_svg.getElementById("map-svg");
        var circleNode = svg.getElementById(droneID);

        var color = 'red';
        if (status == 'idle') {
          color = 'green'
        }
        if (status == 'waiting') {
          color = 'yellow'
        }
        if (circleNode == null) {
          circleNode = doc_svg.createElementNS("http://www.w3.org/2000/svg", "circle");
          circleNode.setAttributeNS(null, 'cx', x);
          circleNode.setAttributeNS(null, 'cy', y);
          circleNode.setAttributeNS(null, 'r', '5');
          circleNode.setAttributeNS(null, 'fill', color);
          circleNode.setAttributeNS(null, 'id', droneID);
          svg.appendChild(circleNode);
        }
        else {
          circleNode.setAttributeNS(null, 'cx', x);
          circleNode.setAttributeNS(null, 'cy', y);
          circleNode.setAttributeNS(null, 'fill', color);
        }
      })
    }
  </script>
</head>

<body>
  <p>Current Position: </p>
  <div id="txt"></div>
  <form action="javascript:Submit()">
    <label for="fname">From address:</label><br>
    <input type="text" id="faddr" name="faddr"><br>
    <label for="lname">To address:</label><br>
    <input type="text" id="taddr" name="taddr"><br><br>
    <input type="submit" value="Search addresses">
  </form>
  <object id="map" data="static/images/lund-map.svg" type="image/svg+xml"></object>
  <script>
    var set_delay = 50,
      callout = function () {
        $.ajax({
          url: 'http://0.0.0.0:5000/callout'
        })
          .done(function (server_response) {
            var avalaible_drones = Object.keys(server_response.drones)
            for (const droneID of avalaible_drones) {
              var x = server_response["drones"][droneID].longitude
              var y = server_response["drones"][droneID].latitude
              var status = server_response["drones"][droneID].status
              LoadDrone(droneID, x, y, status)
            }
            let phone_position = server_response.phone_position
            if(phone_position) {
              LoadPhone(phone_position.long, phone_position.lat)
            }
          })
          .always(function (server_response) {
            setTimeout(callout, set_delay);
          });
      };
    callout();    
  </script>


</body>

</html>